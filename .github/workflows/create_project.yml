name: DotMe - bootstrap project (part 1)

on:
  workflow_dispatch:
  repository_dispatch:
  push:
    branches:
      - main

jobs:
  bootstrap:
    name: Bootstrap DotMe project files (part 1)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository (persist credentials)
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Setup git user
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create basic project structure
        run: |
          set -euo pipefail
          echo "Creating project folders and base files..."

          # Make directories
          mkdir -p app/src/main/java/com/dotme/app
          mkdir -p app/src/main/res/layout
          mkdir -p app/src/main/res/mipmap-anydpi-v26
          mkdir -p app/src/main/assets
          mkdir -p .github/workflows

          # README
          cat > README.md <<'README'
# DotMe
This repository will be populated by GitHub Actions to create a starter Android app (DotMe) with a local VPN ad-blocker scaffold.
README

          # settings.gradle
          cat > settings.gradle <<'SETTINGS'
rootProject.name = 'dotme-starter'
include ':app'
SETTINGS

          # top-level build.gradle (minimal - will be refined later)
          cat > build.gradle <<'BUILD'
buildscript {
  repositories {
    google()
    mavenCentral()
  }
  dependencies {
    classpath 'com.android.tools.build:gradle:8.1.2'
  }
}
allprojects {
  repositories {
    google()
    mavenCentral()
  }
}
BUILD

          # gradle.properties
          cat > gradle.properties <<'GP'
org.gradle.jvmargs=-Xmx1536m
android.useAndroidX=true
GP

          # app-level build.gradle
          cat > app/build.gradle <<'APPBUILD'
plugins {
    id 'com.android.application'
    id 'org.jetbrains.kotlin.android' version '1.9.10' apply false
}
apply plugin: 'com.android.application'
apply plugin: 'kotlin-android'

android {
    compileSdk 34

    defaultConfig {
        applicationId "com.dotme.app"
        minSdk 21
        targetSdk 34
        versionCode 1
        versionName "0.1"
    }

    buildTypes {
        debug {
            applicationIdSuffix ".debug"
        }
        release {
            minifyEnabled false
        }
    }
    namespace "com.dotme.app"
}

dependencies {
    implementation "org.jetbrains.kotlin:kotlin-stdlib:1.9.10"
    implementation "androidx.core:core-ktx:1.12.0"
    implementation "androidx.appcompat:appcompat:1.7.0"
    implementation "com.google.android.material:material:1.9.0"
}
APPBUILD

          # AndroidManifest
          mkdir -p app/src/main
          cat > app/src/main/AndroidManifest.xml <<'MANIFEST'
<manifest package="com.dotme.app"
    xmlns:android="http://schemas.android.com/apk/res/android">

    <uses-permission android:name="android.permission.INTERNET" />

    <application
        android:label="DotMe"
        android:icon="@mipmap/ic_launcher"
        android:allowBackup="true">
        <activity android:name=".MainActivity"
            android:exported="true">
            <intent-filter>
                <action android:name="android.intent.action.MAIN"/>
                <category android:name="android.intent.category.LAUNCHER"/>
            </intent-filter>
        </activity>

        <service
            android:name=".SimpleVpnService"
            android:permission="android.permission.BIND_VPN_SERVICE"
            android:exported="false">
            <intent-filter>
                <action android:name="android.net.VpnService" />
            </intent-filter>
        </service>
    </application>
</manifest>
MANIFEST

          # Basic MainActivity.kt
          cat > app/src/main/java/com/dotme/app/MainActivity.kt <<'MAIN'
package com.dotme.app

import android.app.Activity
import android.content.Intent
import android.net.VpnService
import android.os.Bundle
import android.widget.Button
import android.widget.TextView
import androidx.appcompat.app.AppCompatActivity

class MainActivity : AppCompatActivity() {

    private val VPN_REQUEST_CODE = 0x100

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_main)

        val btnToggle = findViewById<Button>(R.id.btnToggle)
        val tvStatus = findViewById<TextView>(R.id.tvStatus)
        val tvCount = findViewById<TextView>(R.id.tvCount)

        btnToggle.setOnClickListener {
            val prepare = VpnService.prepare(this)
            if (prepare != null) {
                startActivityForResult(prepare, VPN_REQUEST_CODE)
            } else {
                startService(Intent(this, SimpleVpnService::class.java))
            }
        }
    }
}
MAIN

          # SimpleVpnService.kt (minimal scaffold)
          cat > app/src/main/java/com/dotme/app/SimpleVpnService.kt <<'SERVICE'
package com.dotme.app

import android.app.Service
import android.content.Intent
import android.net.VpnService
import android.os.ParcelFileDescriptor
import java.io.FileInputStream
import java.io.FileOutputStream
import kotlin.concurrent.thread

class SimpleVpnService : VpnService() {
    private var vpnInterface: ParcelFileDescriptor? = null
    @Volatile private var running = false

    override fun onStartCommand(intent: Intent?, flags: Int, startId: Int): Int {
        startVpn()
        return Service.START_STICKY
    }

    override fun onDestroy() {
        stopVpn()
        super.onDestroy()
    }

    private fun startVpn() {
        if (vpnInterface != null) return
        val builder = Builder()
            .setSession("DotMeVPN")
            .addAddress("10.0.0.2", 32)
            .addRoute("0.0.0.0", 0)
            .addDnsServer("1.1.1.1")
        vpnInterface = builder.establish()
        running = true

        vpnInterface?.let { pfd ->
            thread {
                val input = FileInputStream(pfd.fileDescriptor)
                val output = FileOutputStream(pfd.fileDescriptor)
                val packet = ByteArray(32767)
                try {
                    while (running) {
                        val length = input.read(packet)
                        if (length > 0) {
                            val s = String(packet, 0, length, Charsets.ISO_8859_1)
                            if (HostsManager.isBlockedPacket(s)) {
                                HostsManager.incrementBlockedCount(applicationContext)
                                continue
                            } else {
                                // Forwarding would be implemented in a later step
                            }
                        } else {
                            Thread.sleep(10)
                        }
                    }
                } catch (e: Exception) {
                    e.printStackTrace()
                } finally {
                    input.close()
                    output.close()
                }
            }
        }
    }

    private fun stopVpn() {
        running = false
        vpnInterface?.close()
        vpnInterface = null
    }
}
SERVICE

          # HostsManager
          cat > app/src/main/java/com/dotme/app/HostsManager.kt <<'HOSTS'
package com.dotme.app

import android.content.Context
import java.io.BufferedReader
import java.io.InputStreamReader
import java.util.concurrent.atomic.AtomicInteger

object HostsManager {
    private val blocked = HashSet<String>()
    private val blockedToday = AtomicInteger(0)

    private const val PREFS = "dotme"
    private const val KEY_BLOCKED_TODAY = "blocked_today"
    private const val KEY_ANALYTICS = "analytics_enabled"

    fun load(context: Context) {
        if (blocked.isNotEmpty()) return
        try {
            val inStream = context.assets.open("hosts.txt")
            val reader = BufferedReader(InputStreamReader(inStream))
            var line: String?
            while (true) {
                line = reader.readLine() ?: break
                val d = line.trim()
                if (d.isNotEmpty() && !d.startsWith("#")) blocked.add(d)
            }
            reader.close()
            val prefs = context.getSharedPreferences(PREFS, Context.MODE_PRIVATE)
            blockedToday.set(prefs.getInt(KEY_BLOCKED_TODAY, 0))
        } catch (e: Exception) {
            e.printStackTrace()
        }
    }

    fun isBlocked(domain: String): Boolean {
        return blocked.contains(domain)
    }

    fun isBlockedPacket(payload: String): Boolean {
        if (blocked.isEmpty()) return false
        for (d in blocked) {
            if (payload.contains(d, ignoreCase = true)) return true
        }
        return false
    }

    fun incrementBlockedCount(context: Context) {
        if (!isAnalyticsEnabled(context)) return
        val newVal = blockedToday.incrementAndGet()
        val prefs = context.getSharedPreferences(PREFS, Context.MODE_PRIVATE)
        prefs.edit().putInt(KEY_BLOCKED_TODAY, newVal).apply()
    }

    fun getBlockedCount(context: Context): Int {
        val prefs = context.getSharedPreferences(PREFS, Context.MODE_PRIVATE)
        return prefs.getInt(KEY_BLOCKED_TODAY, blockedToday.get())
    }

    fun resetBlockedCount(context: Context) {
        blockedToday.set(0)
        val prefs = context.getSharedPreferences(PREFS, Context.MODE_PRIVATE)
        prefs.edit().putInt(KEY_BLOCKED_TODAY, 0).apply()
    }

    fun isAnalyticsEnabled(context: Context): Boolean {
        val prefs = context.getSharedPreferences(PREFS, Context.MODE_PRIVATE)
        return prefs.getBoolean(KEY_ANALYTICS, true)
    }

    fun setAnalyticsEnabled(context: Context, enabled: Boolean) {
        val prefs = context.getSharedPreferences(PREFS, Context.MODE_PRIVATE)
        prefs.edit().putBoolean(KEY_ANALYTICS, enabled).apply()
    }
}
HOSTS

          # Layout (activity_main.xml)
          cat > app/src/main/res/layout/activity_main.xml <<'LAYOUT'
<?xml version="1.0" encoding="utf-8"?>
<LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
    android:orientation="vertical"
    android:padding="24dp"
    android:layout_width="match_parent"
    android:layout_height="match_parent">

    <TextView
        android:id="@+id/tvStatus"
        android:text="DotMe - VPN Ad Block"
        android:textSize="20sp"
        android:layout_width="wrap_content"
        android:layout_height="wrap_content"/>
    <Button
        android:id="@+id/btnToggle"
        android:layout_marginTop="16dp"
        android:text="Start VPN"
        android:layout_width="wrap_content"
        android:layout_height="wrap_content"/>
    <TextView
        android:id="@+id/tvCount"
        android:layout_marginTop="16dp"
        android:text="Blocked today: 0"
        android:layout_width="wrap_content"
        android:layout_height="wrap_content"/>
    <TextView
        android:layout_marginTop="24dp"
        android:text="Long-press the Start button to reset today's blocked count."
        android:layout_width="wrap_content"
        android:layout_height="wrap_content"/>
</LinearLayout>
LAYOUT

          # Sample hosts file
          cat > app/src/main/assets/hosts.txt <<'HOSTSFILE'
# Sample hosts list (compact)
ads.example.com
ads.googleadservices.com
g.doubleclick.net
HOSTSFILE

          echo "Files created."

      - name: Commit bootstrap files
        run: |
          git add .
          git commit -m "bootstrap: create base Android app scaffold (part1)" || echo "no changes to commit"
          git push origin HEAD:main || echo "push failed (credentials?)"

      - name: Show repository status
        run: |
          echo "---- ls ----"
          ls -R
