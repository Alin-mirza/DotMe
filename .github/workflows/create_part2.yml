name: DotMe Part2 - add app files

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]

jobs:
  add_files:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create Android app files
        run: |
          set -euo pipefail
          echo "Creating app source files and resources..."

          mkdir -p app/src/main/java/com/dotme/app
          mkdir -p app/src/main/res/layout
          mkdir -p app/src/main/res/mipmap-anydpi-v26
          mkdir -p app/src/main/assets

          # MainActivity.kt
          cat > app/src/main/java/com/dotme/app/MainActivity.kt <<'KT'
package com.dotme.app

import android.app.Activity
import android.content.Intent
import android.net.VpnService
import android.os.Bundle
import android.widget.Button
import android.widget.TextView
import androidx.appcompat.app.AppCompatActivity

class MainActivity : AppCompatActivity() {
    private val VPN_REQUEST_CODE = 0x100
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_main)
        val btnToggle = findViewById<Button>(R.id.btnToggle)
        val tvCount = findViewById<TextView>(R.id.tvCount)

        btnToggle.setOnClickListener {
            val prepare = VpnService.prepare(this)
            if (prepare != null) {
                startActivityForResult(prepare, VPN_REQUEST_CODE)
            } else {
                startService(Intent(this, SimpleVpnService::class.java))
            }
        }

        btnToggle.setOnLongClickListener {
            HostsManager.resetBlockedCount(applicationContext)
            tvCount.text = "Blocked today: " + HostsManager.getBlockedCount(applicationContext)
            true
        }
    }
}
KT

          # SimpleVpnService.kt
          cat > app/src/main/java/com/dotme/app/SimpleVpnService.kt <<'KT'
package com.dotme.app

import android.app.Service
import android.content.Intent
import android.net.VpnService
import android.os.ParcelFileDescriptor
import java.io.FileInputStream
import java.io.FileOutputStream
import kotlin.concurrent.thread

class SimpleVpnService : VpnService() {
    private var vpnInterface: ParcelFileDescriptor? = null
    @Volatile private var running = false

    override fun onStartCommand(intent: Intent?, flags: Int, startId: Int): Int {
        HostsManager.load(applicationContext)
        startVpn()
        return Service.START_STICKY
    }

    override fun onDestroy() {
        stopVpn()
        super.onDestroy()
    }

    private fun startVpn() {
        if (vpnInterface != null) return
        val builder = Builder()
            .setSession("DotMeVPN")
            .addAddress("10.0.0.2", 32)
            .addRoute("0.0.0.0", 0)
            .addDnsServer("1.1.1.1")
        vpnInterface = builder.establish()
        running = true

        vpnInterface?.let { pfd ->
            thread {
                val input = FileInputStream(pfd.fileDescriptor)
                val packet = ByteArray(32767)
                try {
                    while (running) {
                        val length = input.read(packet)
                        if (length > 0) {
                            val s = String(packet, 0, length, Charsets.ISO_8859_1)
                            if (HostsManager.isBlockedPacket(s)) {
                                HostsManager.incrementBlockedCount(applicationContext)
                                continue
                            }
                        } else {
                            Thread.sleep(10)
                        }
                    }
                } catch (e: Exception) {
                    e.printStackTrace()
                } finally {
                    try { input.close() } catch(_) {}
                }
            }
        }
    }

    private fun stopVpn() {
        running = false
        vpnInterface?.close()
        vpnInterface = null
    }
}
KT

          # HostsManager.kt
          cat > app/src/main/java/com/dotme/app/HostsManager.kt <<'KT'
package com.dotme.app

import android.content.Context
import java.io.BufferedReader
import java.io.InputStreamReader
import java.util.concurrent.atomic.AtomicInteger

object HostsManager {
    private val blocked = HashSet<String>()
    private val blockedToday = AtomicInteger(0)

    private const val PREFS = "dotme"
    private const val KEY_BLOCKED_TODAY = "blocked_today"
    private const val KEY_ANALYTICS = "analytics_enabled"

    fun load(context: Context) {
        if (blocked.isNotEmpty()) return
        try {
            val inStream = context.assets.open("hosts.txt")
            val reader = BufferedReader(InputStreamReader(inStream))
            var line: String?
            while (true) {
                line = reader.readLine() ?: break
                val d = line.trim()
                if (d.isNotEmpty() && !d.startsWith("#")) blocked.add(d)
            }
            reader.close()
            val prefs = context.getSharedPreferences(PREFS, Context.MODE_PRIVATE)
            blockedToday.set(prefs.getInt(KEY_BLOCKED_TODAY, 0))
        } catch (e: Exception) {
            e.printStackTrace()
        }
    }

    fun isBlocked(domain: String): Boolean {
        return blocked.contains(domain)
    }

    fun isBlockedPacket(payload: String): Boolean {
        if (blocked.isEmpty()) return false
        for (d in blocked) {
            if (payload.contains(d, ignoreCase = true)) return true
        }
        return false
    }

    fun incrementBlockedCount(context: Context) {
        if (!isAnalyticsEnabled(context)) return
        val newVal = blockedToday.incrementAndGet()
        val prefs = context.getSharedPreferences(PREFS, Context.MODE_PRIVATE)
        prefs.edit().putInt(KEY_BLOCKED_TODAY, newVal).apply()
    }

    fun getBlockedCount(context: Context): Int {
        val prefs = context.getSharedPreferences(PREFS, Context.MODE_PRIVATE)
        return prefs.getInt(KEY_BLOCKED_TODAY, blockedToday.get())
    }

    fun resetBlockedCount(context: Context) {
        blockedToday.set(0)
        val prefs = context.getSharedPreferences(PREFS, Context.MODE_PRIVATE)
        prefs.edit().putInt(KEY_BLOCKED_TODAY, 0).apply()
    }

    fun isAnalyticsEnabled(context: Context): Boolean {
        val prefs = context.getSharedPreferences(PREFS, Context.MODE_PRIVATE)
        return prefs.getBoolean(KEY_ANALYTICS, true)
    }

    fun setAnalyticsEnabled(context: Context, enabled: Boolean) {
        val prefs = context.getSharedPreferences(PREFS, Context.MODE_PRIVATE)
        prefs.edit().putBoolean(KEY_ANALYTICS, enabled).apply()
    }
}
KT

          # activity_main.xml
          cat > app/src/main/res/layout/activity_main.xml <<'XML'
<?xml version="1.0" encoding="utf-8"?>
<LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
    android:orientation="vertical"
    android:padding="24dp"
    android:layout_width="match_parent"
    android:layout_height="match_parent">

    <TextView
        android:id="@+id/tvStatus"
        android:text="DotMe - VPN Ad Block"
        android:textSize="20sp"
        android:layout_width="wrap_content"
        android:layout_height="wrap_content"/>
    <Button
        android:id="@+id/btnToggle"
        android:layout_marginTop="16dp"
        android:text="Start VPN"
        android:layout_width="wrap_content"
        android:layout_height="wrap_content"/>
    <TextView
        android:id="@+id/tvCount"
        android:layout_marginTop="16dp"
        android:text="Blocked today: 0"
        android:layout_width="wrap_content"
        android:layout_height="wrap_content"/>
    <ToggleButton
        android:id="@+id/toggleAnalytics"
        android:layout_marginTop="16dp"
        android:layout_width="wrap_content"
        android:layout_height="wrap_content"
        android:textOn="Analytics: ON"
        android:textOff="Analytics: OFF" />
    <TextView
        android:layout_marginTop="24dp"
        android:text="Long-press the Start button to reset today's blocked count."
        android:layout_width="wrap_content"
        android:layout_height="wrap_content"/>
</LinearLayout>
XML

          # hosts.txt (compact)
          cat > app/src/main/assets/hosts.txt <<'HOSTS'
# DotMe compact hosts
ads.example.com
ads.googleadservices.com
g.doubleclick.net
ads.youtube.com
ads.facebook.com
HOSTS

          # privacy_policy
          cat > privacy_policy.txt <<'PP'
DotMe Privacy Policy

DotMe uses on-device local VPN for DNS/SNI based ad blocking. No user data is collected or transmitted by default.
PP

          echo "App files created."

      - name: Commit and push app files
        run: |
          git config user.email "actions@github.com"
          git config user.name "GitHub Actions"
          git add app || true
          git add privacy_policy.txt || true
          git commit -m "Part2: add app sources, layout, hosts and privacy policy" || echo "No changes to commit"
          git push origin HEAD:main || echo "Push failed (maybe permissions)"
